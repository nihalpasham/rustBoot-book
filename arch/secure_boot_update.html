<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Secure-Boot &amp; Update - rustBoot Documentation</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Objectives</li><li class="chapter-item expanded "><a href="../objectives.html"><strong aria-hidden="true">1.</strong> Goals</a></li><li class="chapter-item expanded "><a href="../features.html"><strong aria-hidden="true">2.</strong> Features</a></li><li class="chapter-item expanded affix "><li class="part-title">Design and Architecture Overview</li><li class="chapter-item expanded "><a href="../design.html"><strong aria-hidden="true">3.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/core_components.html"><strong aria-hidden="true">3.1.</strong> Components of rustBoot</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture.html"><strong aria-hidden="true">4.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../arch/images.html"><strong aria-hidden="true">4.1.</strong> rustBoot Images</a></li><li class="chapter-item expanded "><a href="../arch/partitions.html"><strong aria-hidden="true">4.2.</strong> rustBoot Partitions</a></li><li class="chapter-item expanded "><a href="../arch/secure_boot_update.html" class="active"><strong aria-hidden="true">4.3.</strong> Secure-Boot & Update</a></li><li class="chapter-item expanded "><a href="../arch/signing_utilities.html"><strong aria-hidden="true">4.4.</strong> Signing Utilities</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Usage</li><li class="chapter-item expanded "><a href="../user_guide.html"><strong aria-hidden="true">5.</strong> Build & Flash</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/nrf52840.html"><strong aria-hidden="true">5.1.</strong> nrf52840</a></li><li class="chapter-item expanded "><a href="../usage/rp2040.html"><strong aria-hidden="true">5.2.</strong> rp2040</a></li><li class="chapter-item expanded "><a href="../usage/rpi4.html"><strong aria-hidden="true">5.3.</strong> rpi4</a></li><li class="chapter-item expanded "><a href="../usage/stm32f411.html"><strong aria-hidden="true">5.4.</strong> stm32f411</a></li><li class="chapter-item expanded "><a href="../usage/stm32f446.html"><strong aria-hidden="true">5.5.</strong> stm32f446</a></li><li class="chapter-item expanded "><a href="../usage/stm32f469.html"><strong aria-hidden="true">5.6.</strong> stm32f469</a></li><li class="chapter-item expanded "><a href="../usage/stm32h723.html"><strong aria-hidden="true">5.7.</strong> stm32h723</a></li><li class="chapter-item expanded "><a href="../usage/stm32f746.html"><strong aria-hidden="true">5.8.</strong> stm32f746</a></li><li class="chapter-item expanded "><a href="../usage/stm32f334.html"><strong aria-hidden="true">5.9.</strong> stm32f334</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Coding Guidelines and Testing</li><li class="chapter-item expanded "><a href="../coding_guide.html"><strong aria-hidden="true">6.</strong> Coding guidelines</a></li><li class="chapter-item expanded "><a href="../testing.html"><strong aria-hidden="true">7.</strong> Testing</a></li><li class="chapter-item expanded affix "><li class="part-title">Continuous Integration</li><li class="chapter-item expanded "><a href="../continuous-integration.html"><strong aria-hidden="true">8.</strong> Continuous Integration</a></li><li class="chapter-item expanded affix "><li class="part-title">For Developers</li><li class="chapter-item expanded "><a href="../for_developers/index.html"><strong aria-hidden="true">9.</strong> For Developers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../for_developers/ref_guide.html"><strong aria-hidden="true">9.1.</strong> Reference Guide</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../misc/contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">rustBoot Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/nihalpasham/rustBoot-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="secure-boot--update"><a class="header" href="#secure-boot--update">Secure Boot &amp; Update</a></h1>
<p>rustBoot supports the following <code>boot and update</code> schemes, depending on the underlying device-type.</p>
<ul>
<li><a href="#mcu-updates"><code>mcu updates:</code></a> to boot and update bare-metal mcu-firmware using a simple <a href="./partitions.html#micro-controller-partitions"><code>partitioning scheme</code></a></li>
<li><a href="#linux-system-updates"><code>linux-system updates:</code></a> to boot and update a linux system.</li>
</ul>
<h2 id="mcu-updates"><a class="header" href="#mcu-updates">mcu updates:</a></h2>
<p>rustBoot implements a small state machine leveraging rust's type-system to enforce compile-time state transition checks. Additionally, it uses the <a href="https://rust-lang.github.io/api-guidelines/future-proofing.html"><code>sealed-trait</code></a> pattern to declare and seal (all possible) valid <code>states</code> and <code>partitions</code>. </p>
<p>The image below captures rustBoot's state transitions.</p>
<p>Upon supplying power to a system, execution usually starts in an mcu's BootROM. The BootROM is a piece of immutable code, also referred to as the <code>root of trust</code>. BootROM(s) are programmed into an mcu's ROM in the factory and may support secure-boot i.e. the ability to cryptographically verify (and pass control to) a 2nd stage executable/binary.</p>
<p><a href="https://github.com/imrank03/rustBoot-book-diagrams/blob/main/bootrom.svg?raw=true"><img src="https://github.com/imrank03/rustBoot-book-diagrams/blob/main/bootrom.svg?raw=true" alt="State Diagram" title="Simplified Block Diagram, 'Root of trust':" /></a></p>
<p>In our case, <code>rustBoot</code> is the 2nd stage. It checks the <a href="./secure_boot_update.html#partition-status">status</a> of <code>BOOT</code> and <code>UPDATE</code> partitions and drives the state machine forward, as shown in the image below.</p>
<blockquote>
<p>Note:</p>
<ul>
<li>there may be many intermediate stages/executables between <code>BootROM</code> and <code>rustBoot</code>. </li>
<li>rustBoot assumes that the target device contains a <code>root of trust</code> with support for digitally verifying cryptographic signatures. </li>
<li>rustBoot will check for firmware integrity and authenticity at appropriate stages during boot/update/rollback.</li>
<li>booting, updating and rolling back are determined by the the state machine.</li>
</ul>
</blockquote>
<p><a href="https://github.com/UdayakumarHidakal/RustBoot-state-diagrams/blob/main/rustBoot_State_Diagram.svg?raw=true"><img src="https://github.com/UdayakumarHidakal/RustBoot-state-diagrams/blob/main/rustBoot_State_Diagram.svg?raw=true" alt="State Diagram" title="State diagram for rustBoot" /></a></p>
<h3 id="partition-status"><a class="header" href="#partition-status">partition status:</a></h3>
<p><a href="./partitions.html#micro-controller-partitions"><code>rustBoot partitions</code></a> use a status byte to track the status of firmware in each partition. The status byte is a 1-byte field stored at the end of each partition. </p>
<p>Possible states are:</p>
<ul>
<li><code>STATE_NEW (0xFF):</code> The image was never staged for boot, or triggered for an update. If an image is present, no flags are active.</li>
<li><code>STATE_UPDATING (0x70):</code> Only valid in the <code>UPDATE</code> partition. The image is marked for update and should replace the current image in <code>BOOT</code>.</li>
<li><code>STATE_TESTING (0x10):</code> Only valid in the <code>BOOT</code> partition. The image has been just updated, and never completed its boot. If present after reboot, it means that the updated image failed to boot, despite being correctly verified. This particular situation triggers a rollback.</li>
<li><code>STATE_SUCCESS (0x00):</code> Only valid in the <code>BOOT</code> partition. The image stored in <code>BOOT</code> has been successfully staged at least once, and the update is now complete.</li>
</ul>
<h3 id="partition-sector-flags"><a class="header" href="#partition-sector-flags">partition sector flags:</a></h3>
<ul>
<li>When an update is triggered, the contents of <code>UPDATE</code> and <code>BOOT</code> are swapped one sector at a time. <code>SWAP</code> is used to temporarily hold a sector during the swap. This ensures that we always store a backup of the original firmware. </li>
<li>rustBoot keeps track of the state of each sector (during a swap), using 4 bits per sector at the end of the <code>UPDATE</code> partition. </li>
<li>Each <code>sector-swap</code> operation corresponds to a different flag-value for a sector in the sector flags area. This means if a swap operation is interrupted, it can be resumed upon reboot.</li>
</ul>
<p><a href="https://github.com/imrank03/rustBoot-book-diagrams/blob/main/partion_and_sector_flags.svg?raw=true"><img src="https://github.com/imrank03/rustBoot-book-diagrams/blob/main/partion_and_sector_flags.svg?raw=true" alt="State Diagram" title="Simplified Block Diagram, Partition Status and Sector Flags:" /></a></p>
<h2 id="linux-system-updates"><a class="header" href="#linux-system-updates">linux-system updates:</a></h2>
<p>linux-system updates rely on an <code>updt.txt</code> file. <code>updt.txt</code> as the name suggests is an update-configuration file containing active and passive image components.</p>
<ul>
<li><strong>active component:</strong> refers to the rustBoot compliant fit-image that's currently in-use. This also implies that the active image has been successfully verified and booted at least once.</li>
<li><strong>passive component:</strong> refers to the rustBoot compliant fit-image that's been marked <code>ready-for-update</code> i.e. the active image has downloaded an update and set the corresponding passive component field in <code>updt.txt</code>. Passive component(s) have an additional field called <code>update_status</code> and can be assigned one of the following values.
<ul>
<li><strong>updating:</strong> The image is marked for update and should replace the current <code>active-image</code>.</li>
<li><strong>testing:</strong> The image has been just updated, and never completed its boot. If present after reboot, it means that the updated image failed to boot, despite being correctly verified. This particular situation triggers a rollback.</li>
<li><strong>success:</strong> The update has been successfully staged at least once, and the update is now complete. </li>
</ul>
</li>
</ul>
<blockquote>
<p>Notes:</p>
<ul>
<li>A valid <code>updt.txt</code> file must (always) contain an active and a passive component.</li>
<li>The active component must contain the fields - <code>image_name</code> and <code>image_version</code>.</li>
<li>The passive component may contain optional fields such as <code>image_name</code>, <code>image_version</code> and <code>update_status</code> </li>
<li><strong>Example:</strong> for what constitutes a <code>valid config file</code>, please see the <code>updt.txt</code> in the rpi4 example.</li>
</ul>
</blockquote>
<h3 id="heres-how-it-works"><a class="header" href="#heres-how-it-works">Here's how it works:</a></h3>
<ul>
<li>rustBoot loads the <code>updt.txt</code> file from the root directory, parses it and retrieves the active and passive components.</li>
<li>it then performs the following checks, assuming an update is available
<ul>
<li>does the active component include valid <code>image_name</code> and <code>image_version</code> fields?</li>
<li>has the passive component's <code>ready_for_update</code> field been set to true?</li>
<li>if yes, have the <code>passive_name</code>, <code>passive_version</code> fields been set and has <code>passive_status</code> been set to either <code>updating</code> or <code>success</code>? i.e. update has been marked as ready (on the next reboot). </li>
<li>is the passive_version field greater than the active? A valid update must have a version greater than the active version.</li>
</ul>
</li>
<li>if all the above checks pass, we attempt to load the update (fit-image) and <em>if any one of above checks fail, we simply load the currently active-image.</em></li>
<li>lastly, rustBoot verifies the loaded fit-image's cryptographic digital signature and additionally checks whether the <code>version-number</code> from <code>updt.txt</code> matches the fit-image's timestamp (to prevent rollback or downgrade attacks). The fit's version number is retrieved from rustBoot's <code>updt.txt</code> file.
<ul>
<li>if a version mismatch arises in the last step, rustBoot attempts to rollback to the currently active-image</li>
</ul>
</li>
</ul>
<p>A note on valid <code>updt.txt</code> configs. They must contain </p>
<ul>
<li>an image name that ends with <code>.itb</code> as its file extension</li>
<li>a valid unix epoch timestamp as its version number and it must start with the <code>ts_</code> prefix.</li>
<li>config keys that are recognized by rustBoot - <code>[active]</code>, <code>[passive]</code></li>
<li>field names that are recognized by rustBoot. - <code>image_name</code>, <code>image_version</code>, <code>ready_for_update_flag</code>, <code>update_status</code> </li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../arch/partitions.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../arch/signing_utilities.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../arch/partitions.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../arch/signing_utilities.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../mermaid.min.js"></script>
        <script type="text/javascript" src="../mermaid-init.js"></script>


    </body>
</html>
